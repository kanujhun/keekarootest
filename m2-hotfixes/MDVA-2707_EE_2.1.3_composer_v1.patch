commit 37629010703138ab3c136329f6ffb47b80958503
Author: Sergey Nosov <snosov@magento.com>
Date:   Wed Feb 1 15:24:32 2017 +0200

    MDVA-2707: [Magento Cloud] Product image gallery look-ups use incorrect ID
    - fix from MAGETWO-63062

diff --git a/vendor/magento/module-catalog/Model/ResourceModel/Product/Collection.php b/vendor/magento/module-catalog/Model/ResourceModel/Product/Collection.php
index 554ed86..4364b15 100644
--- a/vendor/magento/module-catalog/Model/ResourceModel/Product/Collection.php
+++ b/vendor/magento/module-catalog/Model/ResourceModel/Product/Collection.php
@@ -2213,16 +2213,22 @@ class Collection extends \Magento\Catalog\Model\ResourceModel\Collection\Abstrac
         $linkField = $this->getMetadataPool()->getMetadata(ProductInterface::class)->getLinkField();
         $items = $this->getItems();
 
-        $select->where('entity.' . $linkField . ' IN (?)', array_map(function ($item) {
-            return $item->getId();
-        }, $items));
-
+        $select->where(
+            'entity.' . $linkField . ' IN (?)',
+            array_map(
+                function ($item) use ($linkField) {
+                    return $item->getData($linkField);
+                },
+                $items
+            )
+        );
         foreach ($this->getConnection()->fetchAll($select) as $row) {
             $mediaGalleries[$row[$linkField]][] = $row;
         }
 
         foreach ($items as $item) {
-            $mediaEntries = isset($mediaGalleries[$item->getId()]) ? $mediaGalleries[$item->getId()] : [];
+            $mediaEntries = isset($mediaGalleries[$item->getData($linkField)]) ?
+                $mediaGalleries[$item->getData($linkField)] : [];
             $this->getGalleryReadHandler()->addMediaDataToProduct($item, $mediaEntries);
         }
 
